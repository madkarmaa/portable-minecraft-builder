Import-Module -Name ".\helper.psm1" -Force

$apiUrl = "https://api.github.com/repos/overwolf/detection-tool/releases/latest"
$exePattern = "detec*console*win*.exe"

try {
    $exeFile = Invoke-RestMethod -Uri $apiUrl |
        Select-Object -ExpandProperty assets |
        Where-Object { $_.name -like $exePattern } |
        ForEach-Object {
            $assetUrl = $_.browser_download_url
            $outputPath = Join-Path (Get-Location) $_.name
            (New-Object System.Net.WebClient).DownloadFile($assetUrl, $outputPath)

            $_.name
        }

    Log "Checking for malware..."

    Invoke-Expression -Command ".\$exeFile"
    Start-Process powershell.exe -ArgumentList "-Command", '".\check_cf.ps1"' -NoNewWindow -Wait

    Remove-Item -Path ".\check_cf.ps1" -Force
    Remove-Item -Path ".\$exeFile" -Force
}
catch {
    ErrorLog $_
}